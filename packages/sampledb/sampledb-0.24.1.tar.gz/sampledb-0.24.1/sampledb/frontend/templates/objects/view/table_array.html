<!-- array start -->
{% if search_query_attribute %}
  {% set base_search_query_attribute = search_query_attribute %}
{% else %}
  {% set base_search_query_attribute = "" %}
{% endif %}
<div class="row" style="padding-right: 0.75em;">
  {% include "objects/property_label.html" %}
</div>
<div {% if schema.style == "full_width_table" %}class="full-width-table-wrapper"{% else %}style="padding-left:2.5em;"{% endif %}>
  {% if schema["items"]["type"] == 'object' %}
  <table class="table">
    <thead>
      <tr>
        {% set item_property_names = schema["items"].properties.keys() %}
        {% set property_order = schema.get('items', {}).get('propertyOrder', []) %}
        {% for property_name in property_order %}
          {% if property_name in item_property_names %}
          {% set search_query_attribute = base_search_query_attribute + ".%s.%s" | format('?', property_name) %}
          <th scope="col">
            {% if 'tooltip' in schema["items"].properties[property_name] %}
              <span data-toggle="tooltip" data-placement="top" title="{{ schema["items"].properties[property_name].tooltip | get_translated_text }}">
            {% endif %}
            {{ schema["items"].properties[property_name].title | get_translated_text }}
            {% if 'tooltip' in schema["items"].properties[property_name] %}
                <i class="fa fa-question-circle" aria-hidden="true"></i>
              </span>
            {% endif %}
            {% if schema["items"].properties[property_name].type == 'text' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == ""', advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% elif schema["items"].properties[property_name].type == 'quantity' %}
            {% if schema["items"].properties[property_name].units is string and schema["items"].properties[property_name].units.strip() != '1' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == 0' + schema["items"].properties[property_name].units, advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% elif schema["items"].properties[property_name].units is not string and schema["items"].properties[property_name].units | length == 1 and schema["items"].properties[property_name].units[0].strip() != '1' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == 0' + schema["items"].properties[property_name].units[0], advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% else %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == 0', advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% endif %}
            {% elif schema["items"].properties[property_name].type == 'bool' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == True', advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% else %}
            <a href="{{ url_for('.objects', q='!(' + search_query_attribute + ' == null)', advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% endif %}
          </th>
          {% endif %}
        {% endfor %}
        {% for property_name in item_property_names %}
          {% if property_name not in property_order %}
          {% set search_query_attribute = base_search_query_attribute + ".%s.%s" | format('?', property_name) %}
          <th scope="col">
            {% if 'tooltip' in schema["items"].properties[property_name] %}
              <span data-toggle="tooltip" data-placement="top" title="{{ schema["items"].properties[property_name].tooltip | get_translated_text }}">
            {% endif %}
            {{ schema["items"].properties[property_name].title | get_translated_text }}
            {% if 'tooltip' in schema["items"].properties[property_name] %}
                <i class="fa fa-question-circle" aria-hidden="true"></i>
              </span>
            {% endif %}
            {% if schema["items"].properties[property_name].type == 'text' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == ""', advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% elif schema["items"].properties[property_name].type == 'quantity' %}
            {% if schema["items"].properties[property_name].units is string and schema["items"].properties[property_name].units.strip() != '1' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == 0' + schema["items"].properties[property_name].units, advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% elif schema["items"].properties[property_name].units is not string and schema["items"].properties[property_name].units | length == 1 and schema["items"].properties[property_name].units[0].strip() != '1' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == 0' + schema["items"].properties[property_name].units[0], advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% else %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == 0', advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% endif %}
            {% elif schema["items"].properties[property_name].type == 'bool' %}
            <a href="{{ url_for('.objects', q=search_query_attribute + ' == True', advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% else %}
            <a href="{{ url_for('.objects', q=search_query_attribute, advanced='on') }}" class="search-helper"><i class="fa fa-search" aria-hidden="true"></i></a>
            {% endif %}
          </th>
          {% endif %}
        {% endfor %}
      </tr>
    </thead>
    <tbody>
    {% set has_diff = diff is not none and previous_schema is not none and not (diff is mapping) %}
    {% if data is not none or has_diff %}
      {% set loop_length = 0 %}
      {% if data is not none %}
        {% set loop_length = data | length %}
      {% endif %}
      {% if has_diff and diff | length > loop_length %}
        {% set loop_length = diff | length %}
      {% endif %}
      {% for unused in range(loop_length) %}
        {% if data is not none and (data | length) > loop.index0 %}
          {% set item = data[loop.index0] %}
        {% else %}
          {% set item = none %}
        {% endif %}
        {% set name = "item" %}
        {% set tmp_style = schema['style'] %}
        {% set schema = schema['items'] %}
        {% set data = item %}
        {% if has_diff and diff | length > loop.index0  %}
          {% set diff = diff[loop.index0] %}
          {% if 'items' in previous_schema %}
            {% set previous_schema = previous_schema['items'] %}
          {% else %}
            {% set previous_schema = none %}
          {% endif %}
        {% else %}
          {% set diff = none %}
          {% set previous_schema = none %}
        {% endif %}
        {% set entry_index = loop.index0 %}
        {% if diff is not none %}
          {% if '_after' in diff and '_before' in diff %}
            {% set data_rows = [(diff['_before'], 'data-diff-before'), (diff['_after'], 'data-diff-after')] %}
          {% elif '_before' in diff %}
            {% set data_rows = [(diff['_before'], 'data-diff-before')] %}
          {% elif '_after' in diff %}
            {% set data_rows = [(diff['_after'], 'data-diff-after')] %}
          {% else %}
            {% set data_rows = [(data, '')] %}
          {% endif %}
        {% else %}
          {% set data_rows = [(data, '')] %}
        {% endif %}
        {% for data, row_class in data_rows %}
        <tr class="{{ row_class }}">
        {% for property_name in property_order %}
          {% if property_name in item_property_names %}
          <td>
            {% set name = property_name %}
            {% set schema = schema.properties[property_name] %}
            {% set z = schema.update({'parent_style': tmp_style}) %}
            {% set parent_id_prefix = id_prefix %}
            {% set id_prefix = id_prefix + '_' + name + '_' %}
            {% if diff is not none and previous_schema is not none and property_name in diff %}
              {% set diff = diff[property_name] %}
              {% if 'properties' in previous_schema and property_name in previous_schema['properties'] %}
                {% set previous_schema = previous_schema['properties'][property_name] %}
                {{ previous_schema.update({'parent_style': tmp_style}) or '' }}
              {% else %}
                {% set previous_schema = none %}
              {% endif %}
            {% else %}
              {% set diff = none %}
              {% set previous_schema = none %}
            {% endif %}
            {% if data is not none and property_name in data %}
              {% set data = data[property_name] %}
            {% else %}
              {% set data = none %}
            {% endif %}
            {% set search_query_attribute = base_search_query_attribute + ".%d.%s" | format(entry_index, name) %}
            {% set hidden = False %}
            {% include "objects/view/any.html" %}
          </td>
          {% endif %}
        {% endfor %}
        {% for property_name in item_property_names %}
          {% if property_name not in property_order %}
          <td>
            {% set name = property_name %}
            {% set schema = schema.properties[property_name] %}
            {% set z = schema.update({'parent_style': tmp_style}) %}
            {% set parent_id_prefix = id_prefix %}
            {% set id_prefix = id_prefix + '_' + name + '_' %}
            {% if diff is not none and previous_schema is not none and property_name in diff %}
              {% set diff = diff[property_name] %}
              {% if 'properties' in previous_schema and property_name in previous_schema['properties'] %}
                {% set previous_schema = previous_schema['properties'][property_name] %}
                {{ previous_schema.update({'parent_style': tmp_style}) or '' }}
              {% else %}
                {% set previous_schema = none %}
              {% endif %}
            {% else %}
              {% set diff = none %}
              {% set previous_schema = none %}
            {% endif %}
            {% if data is not none and property_name in data %}
              {% set data = data[property_name] %}
            {% else %}
              {% set data = none %}
            {% endif %}
            {% set search_query_attribute = base_search_query_attribute + ".%d.%s" | format(entry_index, name) %}
            {% set hidden = False %}
            {% include "objects/view/any.html" %}
          </td>
          {% endif %}
        {% endfor %}
        </tr>
        {% endfor %}
      {% endfor %}
    {% endif %}
    </tbody>
    <tfoot>
      <tr>
        {% for property_name in item_property_names %}
          <th scope="col"></th>
        {% endfor %}
      </tr>
    </tfoot>
  </table>
  {% elif schema["items"]["type"] == "array" %}
  {% set max_used_fields = [0] %}
  {% if data is not none %}
    {% for item in data %}
      {% if (item | length) > max_used_fields[-1] %}
        {% set tmp = max_used_fields.append(item | length) %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% set max_used_fields = max_used_fields [-1] %}
  <table class="table">
  <thead>
  <tr>
    {% for i in range(max_used_fields) %}
      <th>Field {{ (i+1) }}</th>
    {% endfor %}
  </tr>
  </thead>
  {% if data is not none %}
  {% for item in data %}
    {% if diff is not none and previous_schema is not none and not (diff is mapping) and diff | length > loop.index0  %}
      {% set diff = diff[loop.index0] %}
      {% if 'items' in previous_schema %}
        {% set previous_schema = previous_schema['items'] %}
      {% else %}
        {% set previous_schema = none %}
      {% endif %}
    {% else %}
      {% set diff = none %}
      {% set previous_schema = none %}
    {% endif %}
    {% set entry_index = loop.index0 %}
    {% set item_rows = [(item, '')] %}
    {% if diff is not none and diff is mapping %}
      {% if '_after' in diff and '_before' in diff %}
        {% set item_rows = [(diff['_before'], 'data-diff-after'), (diff['_after'], 'data-diff-before')] %}
      {% elif '_after' in diff %}
        {% set item_rows = [(diff['_after'], 'data-diff-after')] %}
      {% elif '_before' in diff %}
        {% set item_rows = [(diff['_before'], 'data-diff-before')] %}
      {% else %}
        {% set item_rows = [(item, '')] %}
      {% endif %}
    {% endif %}
    {% for item, item_class in item_rows %}
      <tr class="{{ item_class }}">
      {% for field in item %}
        <td>
          {% set name = name ~ "_" ~ loop.index0 %}
          {% set tmp_style = schema['style'] %}
          {% set schema = schema["items"]["items"] %}
          {% set z = schema.update({'parent_style': tmp_style}) %}
          {% set id_prefix = id_prefix + '_{}__{}_'.format(entry_index, loop.index0) %}
          {% set data = field %}
          {% if diff is not none and previous_schema is not none and not (diff is mapping) and diff | length > loop.index0  %}
            {% set diff = diff[loop.index0] %}
            {% if 'items' in previous_schema %}
              {% set previous_schema = previous_schema['items'] %}
              {{ previous_schema.update({'parent_style': tmp_style}) or '' }}
            {% else %}
              {% set previous_schema = none %}
            {% endif %}
          {% else %}
            {% set diff = none %}
            {% set previous_schema = none %}
          {% endif %}
          {% set search_query_attribute = base_search_query_attribute + ".%d.%s" | format(entry_index, name) %}
          {% set hidden = False %}
          {% include "objects/view/any.html" %}
        </td>
      {% endfor %}
      </tr>
    {% endfor %}
  {% endfor %}
  {% endif %}
  <tfoot>
  <tr>
    {% for i in range(max_used_fields) %}
      <th>Field {{ (i+1) }}</th>
    {% endfor %}
  </tr>
  </tfoot>
  </table>
  {% endif %}
  {% if data and data.export_edit_note %}
    <p class="text-muted"><i class="fa fa-share-alt" aria-hidden="true"></i> _('Note:') {{ data.export_edit_note }}</p>
  {% endif %}
</div>
