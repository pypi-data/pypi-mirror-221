import{_ as v}from"./index.165f9ce1.js";import{ah as l,o as m,c as h,V as t,P as n,a as d,T as w,U as S,F as $,a8 as V,O as k,S as O,ar as R,a9 as F,Q as E}from"./vendor-vue.9e61e0af.js";import{F as D}from"./vendor-lib.76301fc3.js";import{H as L}from"./highlight-lib.3654f6d3.js";import{h as H}from"./highlight-util.a4f1867f.js";import{C as I}from"./ConnectStatus.a429b01b.js";import"./element-icon.1ce1c350.js";import"./element-plus.30eb1cab.js";const U={domains:[{message:"\u57DF\u540D\u5217\u8868\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],status:[{message:"\u9A8C\u8BC1\u72B6\u6001\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],start_time:[{message:"SSL\u7B7E\u53D1\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],expire_time:[{message:"SSL\u8FC7\u671F\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}],create_time_label:[{message:"\u521B\u5EFA\u65F6\u95F4\u4E0D\u80FD\u4E3A\u7A7A",required:!0,trigger:"blur"}]},B={name:"",props:{row:{type:Object,default:null}},components:{},data(){return{rules:U,form:{domains:"",status:"",start_time:"",expire_time:"",create_time_label:""}}},computed:{},methods:{async getData(){if(this.row){let i={id:this.row.id};const e=await this.$http.function(i);if(e.code!=0)return;let s=e.data;this.form.domains=s.domains,this.form.status=s.status,this.form.start_time=s.start_time,this.form.expire_time=s.expire_time,this.form.create_time_label=s.create_time_label}},handleCancel(){this.$emit("on-cancel")},handleSubmit(){this.$refs.form.validate(i=>{if(i)this.confirmSubmit();else return!1})},async confirmSubmit(){let i=this.$loading({fullscreen:!0}),e={domains:this.form.domains.split(`
`)};this.row&&(e.id=this.row.id);const s=await this.$http.issueCertificate(e);s.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success",s.data)):this.$msg.error(s.msg),this.$nextTick(()=>{i.close()})}},created(){this.getData()}},j={class:"text-center"};function z(i,e,s,C,a,o){const r=l("el-input"),_=l("el-form-item"),p=l("el-form"),u=l("el-button");return m(),h("div",null,[t(p,{ref:"form",model:a.form,rules:a.rules,"label-width":"100px"},{default:n(()=>[t(_,{label:"id",prop:"id",style:{display:"none"}},{default:n(()=>[t(r,{type:"text",modelValue:a.form.id,"onUpdate:modelValue":e[0]||(e[0]=f=>a.form.id=f),placeholder:"id"},null,8,["modelValue"])]),_:1}),t(_,{label:"\u57DF\u540D\u5217\u8868",prop:"domains"},{default:n(()=>[t(r,{type:"textarea",modelValue:a.form.domains,"onUpdate:modelValue":e[1]||(e[1]=f=>a.form.domains=f),rows:5,placeholder:"\u8BF7\u8F93\u5165\u57DF\u540D\u5217\u8868\uFF0C\u6BCF\u884C\u4E00\u4E2A"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),d("div",j,[t(u,{onClick:o.handleCancel},{default:n(()=>[w("\u53D6 \u6D88")]),_:1},8,["onClick"]),t(u,{type:"primary",onClick:o.handleSubmit},{default:n(()=>[w("\u786E \u5B9A")]),_:1},8,["onClick"])])])}const A=v(B,[["render",z]]);const M={name:"VerifyStep",props:{form:{type:Object}},components:{},data(){return{}},computed:{domain_list(){return this.form.domains.join(" ")},nginxConfig(){return`server {
  listen 80;
  server_name ${this.domain_list};

  location /.well-known/acme-challenge/ {
      alias /var/www/challenges/;
      try_files $uri =404;
  }
}`}},methods:{async getData(){},async handleSubmit(){let i=this.$loading({fullscreen:!0}),e={issue_certificate_id:this.form.id};const s=await this.$http.verifyCertificateById(e);s.code==0?(this.$msg.success("\u9A8C\u8BC1\u6210\u529F"),this.$emit("on-success",s.data)):this.$msg.error(s.msg),this.$nextTick(()=>{i.close()})},downloadVerifyFile(){let i=new Blob([this.form.validation],{type:"application/octet-stream;charset=utf-8"});D.saveAs(i,this.form.token)}},mounted(){L.highlightAll()},created(){this.getData()}},N={class:"mo-form-detail"},q={class:"verify-step__value"},K={class:"verify-step__value"},P=["href"],G={style:{padding:"10px 0","overflow-x":"auto",width:"100%"}},J=["innerHTML"],Q={class:"text-center mt-md"};function W(i,e,s,C,a,o){const r=l("Download"),_=l("el-icon"),p=l("el-link"),u=l("el-form-item"),f=l("el-form"),b=l("el-button");return m(),h("div",N,[t(f,{"label-width":"130px"},{default:n(()=>[t(u,{label:"\u9A8C\u8BC1\u6587\u4EF6",prop:"domain"},{default:n(()=>[t(p,{underline:!1,type:"primary",class:"mr-sm",onClick:o.downloadVerifyFile},{default:n(()=>[t(_,null,{default:n(()=>[t(r)]),_:1}),w("\u70B9\u51FB\u4E0B\u8F7D")]),_:1},8,["onClick"])]),_:1}),t(u,{label:"\u6587\u4EF6\u5185\u5BB9",prop:"create_time"},{default:n(()=>[d("span",q,S(s.form.validation),1)]),_:1}),t(u,{label:"\u670D\u52A1\u5668\u76EE\u5F55",prop:"create_time"},{default:n(()=>[d("span",K,"/.well-known/acme-challenge/"+S(s.form.token),1)]),_:1}),t(u,{label:"HTTP\u5730\u5740",prop:"isp"},{default:n(()=>[(m(!0),h($,null,V(s.form.domain_validation_urls,g=>(m(),h("div",null,[d("a",{href:g,class:"verify-step__value mo-link",target:"_blank"},S(g),9,P)]))),256))]),_:1}),t(u,{label:"Nginx\u914D\u7F6E",prop:"isp"},{default:n(()=>[d("div",G,[d("pre",null,[d("code",{innerHTML:o.nginxConfig},null,8,J)])])]),_:1})]),_:1}),d("div",Q,[t(b,{type:"primary",onClick:o.handleSubmit},{default:n(()=>[w("\u9A8C \u8BC1")]),_:1},8,["onClick"])])])}const X=v(M,[["render",W],["__scopeId","data-v-1fbf3592"]]);const Y={name:"VerifyStep",props:{form:{type:Object}},components:{},data(){return{nginxConfigTemplate:`server {
    listen 443 ssl;
    server_name ${this.form.domain_list};

    ssl_certificate /path/to/${this.form.domains[0]}.pem;
    ssl_certificate_key /path/to/${this.form.domains[0]}.key;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1.2;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_session_cache shared:SSL:50m;
    ssl_dhparam /path/to/server.dhparam;
    ssl_prefer_server_ciphers on;
}`}},computed:{domain_list(){return this.form.domains.join(" ")},nginxConfig(){return H(this.nginxConfigTemplate,{language:"nginx"}).value}},methods:{async getData(){},handleClose(){this.$emit("on-close")},async handleSubmit(){let i=this.$loading({fullscreen:!0}),e={issue_certificate_id:this.form.id};const s=await this.$http.renewCertificate(e);return s.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success",s.data)):this.$msg.error(s.msg),this.$nextTick(()=>{i.close()}),s},downloadSSLKeyFile(){console.log(JSON.stringify(this.form,null,2));let i=new Blob([this.form.ssl_certificate_key],{type:"text/plain;charset=utf-8"}),e=this.form.domains[0];D.saveAs(i,`${e}.key`)},async downloadSSLFile(){if(!this.form.ssl_certificate){const s=await this.handleSubmit();this.form.ssl_certificate=s.data.ssl_certificate}let i=new Blob([this.form.ssl_certificate],{type:"text/plain;charset=utf-8"}),e=this.form.domains[0];D.saveAs(i,`${e}.pem`)}},mounted(){L.highlightAll()},created(){this.getData()}},Z={class:"mo-form-detail"},ee={style:{padding:"10px 0","overflow-x":"auto"}},te=["innerHTML"],se={class:"text-center mt-md"};function ie(i,e,s,C,a,o){const r=l("Download"),_=l("el-icon"),p=l("el-link"),u=l("el-form-item"),f=l("el-form"),b=l("el-button");return m(),h("div",Z,[t(f,{"label-width":"130px"},{default:n(()=>[t(u,{label:"\u79C1\u94A5",prop:"domain"},{default:n(()=>[t(p,{underline:!1,type:"primary",class:"mr-sm",onClick:o.downloadSSLKeyFile},{default:n(()=>[t(_,null,{default:n(()=>[t(r)]),_:1}),w("\u70B9\u51FB\u4E0B\u8F7D")]),_:1},8,["onClick"])]),_:1}),t(u,{label:"\u516C\u94A5",prop:"domain"},{default:n(()=>[t(p,{underline:!1,type:"primary",class:"mr-sm",onClick:o.downloadSSLFile},{default:n(()=>[t(_,null,{default:n(()=>[t(r)]),_:1}),w("\u70B9\u51FB\u4E0B\u8F7D")]),_:1},8,["onClick"])]),_:1}),t(u,{label:"Nginx\u914D\u7F6E",prop:"domain"},{default:n(()=>[d("div",ee,[d("pre",null,[d("code",{innerHTML:o.nginxConfig},null,8,te)])])]),_:1})]),_:1}),d("div",se,[t(b,{type:"primary",onClick:o.handleClose},{default:n(()=>[w("\u5173 \u95ED")]),_:1},8,["onClick"])])])}const ne=v(Y,[["render",ie],["__scopeId","data-v-047a985f"]]),le={name:"IssueCertificateStep",props:{row:{type:Object}},components:{DataForm:A,VerifyStep:X,RenewStep:ne},data(){return{activeStep:0,issue_certificate_id:null,form:{id:null,domains:[],domain_validation_urls:[],validation:"",token:"",status:"",ssl_certificate_key:"",ssl_certificate:""},setpList:[{title:"\u586B\u5199\u57DF\u540D"},{title:"\u90E8\u7F72\u9A8C\u8BC1\u6587\u4EF6"},{title:"\u4E0B\u8F7D\u8BC1\u4E66"}]}},computed:{},methods:{async getData(){if(!this.issue_certificate_id)return;let i={issue_certificate_id:this.issue_certificate_id};const e=await this.$http.getIssueCertificateById(i);if(!!e.ok){for(let s in this.form)this.form[s]=e.data[s];e.data.ssl_certificate?this.activeStep=3:e.data.status=="valid"?this.activeStep=2:e.data.status=="pending"?this.activeStep=1:this.activeStep=0}},handleIssueSuccess(i){this.issue_certificate_id=i.id,this.getData()},handleVerifySuccess(){this.getData()}},created(){this.row&&(this.issue_certificate_id=this.row.id),this.getData()}},ae={class:""},oe={class:"mt-md"};function re(i,e,s,C,a,o){const r=l("el-step"),_=l("el-steps"),p=l("el-divider"),u=l("DataForm"),f=l("VerifyStep"),b=l("RenewStep");return m(),h("div",ae,[t(_,{active:a.activeStep,"align-center":"","finish-status":"success"},{default:n(()=>[(m(!0),h($,null,V(a.setpList,g=>(m(),k(r,{title:g.title},null,8,["title"]))),256))]),_:1},8,["active"]),t(p),d("div",oe,[a.activeStep==0?(m(),k(u,{key:0,onOnSuccess:o.handleIssueSuccess,onOnCancel:e[0]||(e[0]=g=>i.$emit("on-cancel"))},null,8,["onOnSuccess"])):a.activeStep==1?(m(),k(f,{key:1,form:a.form,onOnSuccess:o.handleVerifySuccess},null,8,["form","onOnSuccess"])):a.activeStep==2||a.activeStep==3?(m(),k(b,{key:2,form:a.form,onOnClose:e[1]||(e[1]=g=>i.$emit("on-cancel"))},null,8,["form"])):O("",!0)])])}const ce=v(le,[["render",re]]),de={name:"",props:{row:{type:Object,default:null},visible:{type:Boolean,default:!1}},emits:["update:visible"],components:{DataForm:A,IssueCertificateStep:ce},data(){return{}},computed:{dialogTitle(){return this.row?"\u7F16\u8F91":"\u7533\u8BF7SSL\u8BC1\u4E66"},dialogVisible:{get(){return this.visible},set(i){this.$emit("update:visible",i)}}},methods:{handleClose(){this.$emit("update:visible",!1)},handleOpen(){this.$emit("update:visible",!0)},handleSuccess(){this.handleClose(),this.$emit("on-success")}},created(){}};function ue(i,e,s,C,a,o){const r=l("IssueCertificateStep"),_=l("el-dialog");return m(),k(_,{title:"\u7533\u8BF7SSL\u8BC1\u4E66",modelValue:o.dialogVisible,"onUpdate:modelValue":e[0]||(e[0]=p=>o.dialogVisible=p),width:"900px",center:"","append-to-body":""},{default:n(()=>[o.dialogVisible?(m(),k(r,{key:0,row:s.row,onOnCancel:o.handleClose,onOnSuccess:o.handleSuccess},null,8,["row","onOnCancel","onOnSuccess"])):O("",!0)]),_:1},8,["modelValue"])}const T=v(de,[["render",ue]]),me={name:"",components:{DataFormDialog:T,ConnectStatus:I},props:{list:{type:Array}},computed:{},data(){return{currentRow:null,dialogVisible:!1}},methods:{handleEditRow(i){this.currentRow=i,this.dialogVisible=!0},async handleDeleteClick(i){let e={id:i.id};const s=await this.$http.function(e);s.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(s.msg)},async handleStatusChange(i){let e={id:i.id};const s=await this.$http.function(e);s.code==0?(this.$msg.success("\u64CD\u4F5C\u6210\u529F"),this.$emit("on-success")):this.$msg.error(s.msg)},handleUpdateSuccess(){this.$emit("on-success")}},created(){}},_e={style:{"margin-left":"4px"}};function pe(i,e,s,C,a,o){const r=l("el-table-column"),_=l("ConnectStatus"),p=l("Tickets"),u=l("el-icon"),f=l("el-link"),b=l("el-table"),g=l("DataFormDialog");return m(),h("div",null,[t(b,{data:s.list,stripe:"",border:""},{default:n(()=>[t(r,{label:"ID",align:"center",prop:"id",width:"60"},{default:n(c=>[d("span",null,S(c.row.id||"-"),1)]),_:1}),t(r,{label:"\u57DF\u540D","header-align":"center",align:"center",prop:"domains"},{default:n(c=>[(m(!0),h($,null,V(c.row.domains,x=>(m(),h("div",null,S(x),1))),256))]),_:1}),t(r,{label:"\u9A8C\u8BC1\u72B6\u6001","header-align":"center",align:"center",prop:"status",width:"80"},{default:n(c=>[t(_,{value:c.row.show_status,onOnClick:x=>i.handleShowAddressListgDialog(c.row)},null,8,["value","onOnClick"]),d("span",_e,S(c.row.status_label||"-"),1)]),_:1}),t(r,{label:"SSL\u7B7E\u53D1\u65F6\u95F4","header-align":"center",align:"center",prop:"start_time",width:"160"},{default:n(c=>[d("span",null,S(c.row.start_time||"-"),1)]),_:1}),t(r,{label:"SSL\u8FC7\u671F\u65F6\u95F4","header-align":"center",align:"center",prop:"expire_time",width:"160"},{default:n(c=>[d("span",null,S(c.row.expire_time||"-"),1)]),_:1}),t(r,{label:"\u521B\u5EFA\u65F6\u95F4","header-align":"center",align:"center",prop:"create_time_label"},{default:n(c=>[d("span",null,S(c.row.create_time_label||"-"),1)]),_:1}),t(r,{label:"\u67E5\u770B",width:"60","header-align":"center",align:"center"},{default:n(c=>[t(f,{underline:!1,type:"primary",onClick:x=>o.handleEditRow(c.row)},{default:n(()=>[t(u,null,{default:n(()=>[t(p)]),_:1})]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),t(g,{visible:a.dialogVisible,"onUpdate:visible":e[0]||(e[0]=c=>a.dialogVisible=c),row:a.currentRow,onOnSuccess:o.handleUpdateSuccess},null,8,["visible","row","onOnSuccess"])])}const fe=v(me,[["render",pe]]),he={name:"issue-certificate-list",props:{},components:{DataFormDialog:T,DataTable:fe},data(){return{list:[],total:0,page:1,size:20,keyword:"",loading:!0,dialogVisible:!1}},computed:{},methods:{resetData(){this.page=1,this.getData()},async getData(){this.loading=!0;let i={page:this.page,size:this.size,keyword:this.keyword};try{const e=await this.$http.getCertificateList(i);e.code==0&&(this.list=e.data.list.map(s=>(s.show_status=null,s.status_label="\u672A\u77E5",s.status=="pending"?(s.show_status=!1,s.status_label="\u672A\u9A8C\u8BC1"):s.status=="valid"&&(s.show_status=!0,s.status_label="\u5DF2\u9A8C\u8BC1"),s)),this.total=e.data.total)}catch(e){console.log(e)}finally{this.loading=!1}},handleAddRow(){this.dialogVisible=!0},handleAddSuccess(){this.resetData()},handleSearch(){this.resetData()}},created(){this.getData()}},ge={class:"app-container"},be={class:"margin-bottom--20"};function Se(i,e,s,C,a,o){const r=l("Plus"),_=l("el-icon"),p=l("el-button"),u=l("Search"),f=l("el-input"),b=l("DataTable"),g=l("el-pagination"),c=l("DataFormDialog"),x=R("loading");return m(),h("div",ge,[d("div",be,[t(p,{type:"primary",onClick:o.handleAddRow},{default:n(()=>[t(_,null,{default:n(()=>[t(r)]),_:1}),w("\u7533\u8BF7")]),_:1},8,["onClick"]),t(f,{class:"ml-sm",style:{width:"260px"},modelValue:a.keyword,"onUpdate:modelValue":e[0]||(e[0]=y=>a.keyword=y),placeholder:"\u8F93\u5165\u57DF\u540D",clearable:"",onKeypress:F(o.handleSearch,["enter"]),onClear:o.handleSearch},{append:n(()=>[t(p,{onClick:o.handleSearch},{default:n(()=>[t(_,null,{default:n(()=>[t(u)]),_:1})]),_:1},8,["onClick"])]),_:1},8,["modelValue","onKeypress","onClear"])]),E(t(b,{class:"mt-md",list:a.list,onOnSuccess:o.resetData,onOnEditRow:i.handleEditRow},null,8,["list","onOnSuccess","onOnEditRow"]),[[x,a.loading]]),t(g,{class:"mt-md justify-center",background:"",layout:"total, prev, pager, next",total:a.total,"page-size":a.size,"onUpdate:pageSize":e[1]||(e[1]=y=>a.size=y),"current-page":a.page,"onUpdate:currentPage":e[2]||(e[2]=y=>a.page=y),onCurrentChange:o.getData},null,8,["total","page-size","current-page","onCurrentChange"]),t(c,{visible:a.dialogVisible,"onUpdate:visible":e[3]||(e[3]=y=>a.dialogVisible=y),onOnSuccess:o.handleAddSuccess},null,8,["visible","onOnSuccess"])])}const Ve=v(he,[["render",Se]]);export{Ve as default};
