{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
 
</style>
{% endblock extra_css%}

{% block content %}
<div class="container-fluid">
    <nav class="navbar navbar-expand-sm topbar fixed-top secondNavbarStyle">
        <div class="insertInlineBlock marginTop5px">
            <div class="dropdown" style="display:inline-block">
                <a class="dropdown-toggle" id="getEnvSelections" data-toggle="dropdown" role='button' aria-haspopup=true aria-expanded=false>
                    Select Envs
                </a>
    
                <div class="dropdown-menu" style="width:300px; height:500px; overflow:auto" id="envDropdownMenu">
                    <div id="insertEnvSelections" style="margin-left:20px">{{ envDropdownMenu|safe }}</div>
                    
                    <br>
    
                    <div style="margin-left:20px">
                        <button type="submit" class="btn btn-sm btn-primary mt-2 ml-0 mb-3" style="padding-left:5px; padding-right:5px;" onclick="clearEnvSelections()">Reset</button>

                        <!-- <button type="submit" class="btn btn-sm btn-primary mt-2 ml-3 mb-3" style="padding-left:5px; padding-right:5px;" onclick="collectSelectedEnvs()">Select</button> -->

                        <button type="submit" class="btn btn-sm btn-danger mt-2 ml-3 mb-3" style="padding-left:5px; padding-right:5px;" onclick="closeEnvDropdown()">Close / Discard</button>
                    </div>
                </div>
            </div> 

            &emsp;&emsp;
            <div class="dropdown" style="display:inline-block">
                <a class="dropdown-toggle" data-toggle="dropdown" role='button' aria-haspopup=true aria-expanded=false>
                    Show <span id="insertDay"></span>
                </a>
    
                <div class="dropdown-menu" style="width:300px; height:300px; overflow:auto" id="envDropdownMenu">
                    <div style="margin-left:20px">
                        <a href="#" value="today" onclick="showEnvUsage(this)">Today</a><br>
                        <a href="#" value="yesterday" onclick="showEnvUsage(this)">Since Yesterday</a><br>
                        <a href="#" value="7"    onclick="showEnvUsage(this)">Last 7 days</a><br>
                        <a href="#" value="14"   onclick="showEnvUsage(this)">Last 2 weeks</a><br>
                        <a href="#" value="31"   onclick="showEnvUsage(this)">Last Month</a><br>
                        <a href="#" value="93"   onclick="showEnvUsage(this)">Last 3 Months</a><br>
                        <a href="#" value="186"  onclick="showEnvUsage(this)">Last 6 Months</a><br>
                        <a href="#" value="365"  onclick="showEnvUsage(this)">Last Year</a><br>
                        <a href="#" value="730"  onclick="showEnvUsage(this)">Last 2 Years</a><br>
                        <a href="#" value="1095" onclick="showEnvUsage(this)">Last 3 Years</a><br>
                    </div>
                </div>
            </div>

            &emsp;&emsp;
            <button type="submit" class="btn btn-sm btn-primary" onclick=go()>Get Utilizations</button>
        </div>
    </nav>

    <ul class="nav nav-tabs" style="margin-top:10px">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="go()">Env Usage</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showUserUsage()">User Usage</a>
        </li>

        <!--
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showUserTimestamp()">User Timestamp</a>
        </li>
        -->
    </ul>

    <canvas id="userChart"></canvas>
    <canvas id="barChart" style="max-width:700px;"></canvas>
    <!-- <canvas id='userUsageTimestamps' style="margin:0"></canvas> -->

</div>
{% endblock content %}

{% block extra_js %}
<!-- References: https://www.chartjs.org/docs/latest/samples/bar/vertical.html -->

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script> -->
<script src="{% static "chartJS/Chart.js" %}"></script>

<!-- <script src="{% static "commons/js/keystackCharts.js" %}"></script> -->

<script>
    // Default to get last 31 days of usage for all envs
    var selectedEnvList = new Array();
    var days = 31;
    var barChartObj = null;

    document.addEventListener("DOMContentLoaded", function() {
        //document.querySelector("#footer").remove();
        //document.querySelector("#mainBodyDiv").style.height = "100vh";

        // google.charts.load('current', {packages: ['corechart', 'bar']});
        // google.charts.setOnLoadCallback(showEnvUsage);

        /*
        if (sessionStorage.getItem('controller') != sessionStorage.getItem('mainControllerIp')) {
            hideClassFromRemoteControllers();
        } 
        if (sessionStorage.getItem('controller') == sessionStorage.getItem('mainControllerIp')) {
            unhideClassFromRemoteControllers();
        }
        */
        
        showEnvUsage(object=null, getUtilization=true);
        getServerTime();
    });

    function collectSelectedEnvs() {
        // Collect all the selected checkboxes and close the dropdown menu
        var checkboxArray = document.querySelectorAll('input[name=envCheckboxes]:checked');
        selectedEnvList = [];

        for (let x=0; x < checkboxArray.length; x++) {
            let env = checkboxArray[x].getAttribute('value');
            selectedEnvList.push(env);
        }

        if (selectedEnvList.indexOf('allEnvs') >= 0) {
            selectedEnvList = ['allEnvs'];
        }

        if (selectedEnvList.length == 0) {
            selectedEnvList = ['allEnvs'];
        }
    }

    function clearEnvSelections() {
        const envSelections = document.getElementsByName('envCheckboxes');
        envSelections.forEach(checkbox => {
            checkbox.checked = false;
        })
    }

    // Don't close the dropdown-menu when clicking inside
    document.querySelector('#envDropdownMenu').addEventListener('click', function(event) {
        event.stopPropagation();
    })

    // Reset the selectedEnvList if user clicks on the dropdown menu
    document.querySelector('#getEnvSelections').addEventListener('change', function(event) {
        var selectedEnvList = [];
        clearEnvSelections();
    })

    function closeEnvDropdown() {
        document.querySelector('#getEnvSelections').click();
    }

    function go(object=null) {
        showEnvUsage(object=object, getUtilization=true);
    }

    async function showEnvUsage(object=null, getUtilization=false) {
        /* dropdown menu selection will call this function */
        // {'timestamp': datetime.datetime(2022, 11, 19, 16, 15, 48, 425000), 
        //  'meta': {'env': 'pythonSample', 'user': 'Hubert Gee'}}

        if (object) {
            const userDefinedDays = object.getAttribute("value");
            if (userDefinedDays == 'today') {
                days = 1;
            } else if (userDefinedDays == 'yesterday') {
                days = 2;
            } else {
                days = userDefinedDays;
            }
        }

        collectSelectedEnvs();
        document.querySelector("#insertDay").innerHTML = `last ${days} days`;

        // Clear everything
        //let timestamp = document.querySelector("#userUsageTimestamps")
        //if (timestamp) {
        //    timestamp.innnerHTML = '';
        //}

        console.log(`showEnvUsage object=null. days=${days}. selectedEnvs:${selectedEnvList}`)

        if (getUtilization) {
            let userPieCharts = document.querySelectorAll('.userPieChartClass');
            userPieCharts.forEach(divClass => {
                if (divClass) {
                    divClass.remove();
                }
            });

            console.log(`showEnvUsage: selectedEnvList: ${selectedEnvList}  ${days}: days`)

            const envData = await postData("{% url "getEnvBarChart" %}", "{{csrf_token}}", 'POST', 
                                                    {remoteController: sessionStorage.getItem("remoteController"),
                                                     selectedEnvs: selectedEnvList, 
                                                     lastNumberOfDays: days});

            if (envData.envs == "") {
                document.querySelector('#barChart').innerHTML = `Envs were not used in the last ${days} days`  
            } else {
                //var xValues = ["Italy", "France", "Spain", "USA", "Argentina"];
                //var yValues = [55, 49, 44, 24, 15];
                //var barColors = ["red", "green","blue","orange","brown"];

                // show:  
                let barChartDiv = document.querySelector("#barChart");
                barChartDiv.style.display = "block";

                // Hide
                let userChartDiv = document.querySelector("#userChart");
                userChartDiv.style.display = "none";

                if (barChartObj == null) {
                    barChartObj = new Chart("barChart", {
                        type: "bar",
                        data: {
                            labels: envData.envs,
                            datasets: [{backgroundColor: envData.colors, data: envData.utilizations}]
                        },
                        options: {
                            title: {
                            display: true,
                            text: "ENVs"
                            },
                            legend: {
                            display: false
                            },
                            scales: {
                            yAxes: [{ticks: {beginAtZero:true}}]
                            }
                        }
                    })
                } else {
                    barChartObj.clear();
                    barChartObj.data.datasets = [{backgroundColor: envData.colors, data: envData.utilizations}];
                    barChartObj.data.labels = envData.envs;
                    barChartObj.update();
                }
            }
        }
    }

    async function showUserUsage(object=null) {
        /* dropdown menu selection will call this function */
        // {'timestamp': datetime.datetime(2022, 11, 19, 16, 15, 48, 425000), 
        //  'meta': {'env': 'pythonSample', 'user': 'Hubert Gee'}}
        if (object) {
            userDefinedDays = object.getAttribute("value");
            if (userDefinedDays == 'today') {
                days = 1;
            } else if (userDefinedDays == 'yesterday') {
                days = 2;
            } else {
                days = userDefinedDays;
            }
        }

        // Clear everything
        let userPieCharts = document.querySelectorAll('.userPieChartClass');
        userPieCharts.forEach(divClass => {
            divClass.remove();
        });

        let barChartDiv = document.querySelector('#barChart');
        barChart.innerHTML = "";
        if (typeof(barChartDiv) != "undefined"  && barChartDiv != 'null') {
            if (barChartDiv) {
                // Hide
                barChartDiv.style.display = "none";
            }
        }

        collectSelectedEnvs();

        console.log(`showUserUsage: selectedEnvList: ${selectedEnvList}  ${days}: days`)
        const envData = await postData("{% url "getUserUsageBarChart" %}", "{{csrf_token}}", 'POST', 
                                                {remoteController: sessionStorage.getItem("remoteController"),
                                                 selectedEnvs: selectedEnvList,
                                                 lastNumberOfDays: days});

        if (envData.envs == "") {
            document.querySelector('#userChart').innerHTML = `Envs were not used in the last ${days} days`  
        } else {
            var userChartDiv = document.querySelector("#userChart");

            // Create a new div for each env and put the pie chart in the new divs
            envData.envs.forEach(env => {
                /* 
                envs: [['loadcoreSample', [['Hubert Gee', 2, 'darkorange'], ['hgee', 43, 'darkred']]], ['pythonSample', [['Hubert Gee', 1, 'darkorchid'], ['hgee', 77, 'darkslategray']]], ['hubert', [['Hubert Gee', 3, 'darkturquoise'], ['hgee', 50, 'blue']]], ['global', [['Hubert Gee', 1, 'red']]]]
                */

                var newDiv = document.createElement("canvas");
                newDiv.className = 'userPieChartClass'
                newDiv.id = env[0]
                newDiv.style = "width:1300px; height:300px; margin-bottom:50px;";

                let currentEnvUsers = new Array();
                let currentEnvUserCounter = new Array();
                let currentEnvUserColor = new Array();

                env[1].forEach(user => {
                    currentEnvUsers.push(user[0]);
                    currentEnvUserCounter.push(user[1]);
                    currentEnvUserColor.push(user[2]);
                })

                userChartDiv.parentNode.appendChild(newDiv, userChartDiv.nextSibling);

                userChartObj = new Chart(newDiv, {
                    type: "bar",
                    data: {
                    labels: currentEnvUsers,
                    datasets: [{backgroundColor: currentEnvUserColor, data: currentEnvUserCounter}]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: true,
                        title: {
                            display: true,
                            text: `ENV: ${env[0]}`
                        },
                        legend: {
                            display: false
                        },
                        scales: {
                            yAxes: [{ticks: {beginAtZero:true}}]
                        }
                    }
                });
            })
        }
    }

    async function showUserTimestamp(object=null) {
        /* dropdown menu selection will call this function */
        // {'timestamp': datetime.datetime(2022, 11, 19, 16, 15, 48, 425000), 
        //  'meta': {'env': 'pythonSample', 'user': 'Hubert Gee'}}
        if (object == null) {
            if (days == null) {
                days = 7;
            }

            selectedEnvList = ['allEnvs']
        } else {
            days = object.getAttribute("value");
            if (days == 'today') {
                days = 1
            }

            if (days == 'yesterday') {
                days = 2
            }
        }

        // Clear everything
        document.querySelector('#barChart').innerHTML = '';
        /*
        let userPieCharts = document.querySelectorAll('.userPieChartClass');
        userPieCharts.forEach(divClass => {
            divClass.remove()
        });
        */

        collectSelectedEnvs();

        const envData = await postData("{% url "getEnvBarChart" %}", "{{csrf_token}}", 'POST', 
                                                {selectedEnvs:selectedEnvList, lastNumberOfDays:days});

        if (envData.envBarChartList == "") {
            document.querySelector('#userUsageTimestamps').innerHTML = `Envs were not used in the last ${days} days`  
        } else {
            // user pie chart
            document.querySelector("#userUsageTimestamps").innerHTML = envData.userUsageTimestamps;
        }
    }

</script>
{% endblock extra_js %}