{% extends "base.html" %}
{% load static %}

{% block extra_css %}
	<link href={% static "commons/css/testResultsTreeView.css" %} rel="stylesheet" type="text/css">

<style>
	.keystackDetailedLogs li .submenu { 
        list-style: none; 
	}

	/*
	section {
		width:500px; 
		//height:500px;
		//padding:10px; 
		//border-width:1px; 
		//border-style:solid; 
		//border-color:gray;
		//overflow-x:scroll;
		//overflow-y:scroll;
		//overflow:auto;
	}
	*/

	/*
	.keystackDetailedLogs li .submenu { 
        list-style: none; 
        margin: 0; 
        padding: 0; 
        padding-left: 1rem; 
        padding-right: 1rem;
    }

    .keystackDetailedLogs .nav-link {
        font-weight: 500;
        font-size: 14px;
        color: var(--bs-dark);
        line-height: .1;
    }

    .keystackDetailedLogs .nav-link:hover {
        color: var(--bs-primary);
    }
	*/
</style>	
{% endblock extra_css %}

{% block content %}

<!-- testResultsPath is passed in from sessionMgmt.views.SessionDetails(). For JS. -->
<div id="testResultsPath" path={{testResultsPath}}></div>

<div class="container-fluid">
	<nav class="navbar navbar-expand-sm topbar fixed-top secondNavbarStyle">
		<div class="insertInlineBlock marginTop5px">
			<a href="/sessionMgmt">Return to Pipelines</a>
		</div>
	</nav>

  	<section class="mt-3" id="insertSessionData"></section>
	<section class="mt-3" id="insertTestcaseData"></section>

  	<!-- <section id="insertDetailedLogs" style='display:inline-block; margin-left:10px;'></section> -->
</div>

{% endblock content %}

{% block extra_js %}
<script>
	document.addEventListener("DOMContentLoaded", function() {
		getSessionData();
		getTestcaseData();
	});

	setInterval(getSessionData, 3000);
	//var testcaseDataInterval = setInterval(getTestcaseData, 3000)

	async function getSessionData() {
		// testResultPath was passed in by sessionMgmt.views.SessionDetails()
		let testResultsPath = document.querySelector('#testResultsPath').getAttribute('path');
		const data = await postData("{% url "getSessionDetails" %}", "{{csrf_token}}", 'POST', {'testResultsPath': testResultsPath});
		document.querySelector('#insertSessionData').innerHTML = data.sessionData;
		document.querySelector('#topbarTitlePage').innerHTML = `${data.stageModuleEnv}`
	}

	async function getTestcaseData() {
		//if (testcaseDataInterval) {
			// testResultPath was passed in by sessionMgmt.views.SessionDetails()
			let testResultsPath = document.querySelector('#testResultsPath').getAttribute('path');
			const data = await postData("{% url "getSessionDetails" %}", "{{csrf_token}}", 'POST', {'testResultsPath': testResultsPath});

			document.querySelector('#insertTestcaseData').innerHTML = data.testcaseData;
			document.querySelector('#topbarTitlePage').innerHTML = `${data.stageModuleEnv}`
			await addListeners(caretName="caret2");
		//}

		/*
		document.querySelectorAll('.keystackDetailedLogs .nav-link').forEach(function(element){
			element.addEventListener('click', function (e) {
				let nextEl = element.nextElementSibling;
				let parentEl  = element.parentElement;	
	
				if(nextEl) {
					e.preventDefault();	
					let mycollapse = new bootstrap.Collapse(nextEl);
					if(nextEl.classList.contains('show')){
						mycollapse.hide();
						testcaseDataInterval = setInterval(getTestcaseData, 3000)
					} else {
						mycollapse.show();
						
						if (testcaseDataInterval) {
							clearInterval(testcaseDataInterval)
							testcaseDataInterval = null;
						} else {
							testcaseDataInterval = setInterval(getTestcaseData, 3000)
						}
						// find other submenus with class=show
						var opened_submenu = parentEl.parentElement.querySelector('.submenu.show');
						// if it exists, then close all of them
						if(opened_submenu){
							new bootstrap.Collapse(opened_submenu);
						}
					}
				}
			});
		});
		*/		
	}

	async function getFileContents(object) {
        try {
            document.querySelector("#modalShowTestLogs");
            let filePath = object.getAttribute('filePath');
            console.log(`sessionDetails.getFileContents(): filePath: ${filePath}`)

            const data = await postData("{% url "getFileContents" %}", "{{csrf_token}}", 'POST', {filePath: filePath})

            // Show file contents in a new tab
            var myWindow = window.open("", '_blank');
            myWindow.document.write(`<pre>${data.fileContents}</pre>`);

        } catch (error) {
            console.log("fileMgmt.getFileContents() error: " + error)
        }
    }

    function addListeners(caretName, newVarName='x') {
        // caret2
        window[caretName] = document.getElementsByClassName(caretName);

		// By default, open the top-level folder to show the testcases
		window[caretName][0].parentElement.querySelector(".nested").classList.toggle("active")

        for (x= 1; x < window[caretName].length; x++) {
            window[caretName][x].addEventListener("click", function() {
                this.parentElement.querySelector(".nested").classList.toggle("active");
                //this.classList.toggle("caret-down");
            });
        }

		/*
		// Disable getTestcaseData intervals when a user clicks open the top-level folder
		window[caretName][0].addEventListener("click", function() {
			if (this.parentElement.querySelector(".nested").classList.contains("active") == false) {
				testcaseDataInterval = setInterval(getTestcaseData, 3000)
			}
		});

		// Enable getTestcaseData interval when user closes the top-level folder
		window[caretName][0].addEventListener("click", function() {
			if (this.parentElement.querySelector(".nested").classList.contains("active") == true) {
				testcaseDataInterval = null;
			}
		});
		*/
    }

</script>
{% endblock extra_js%}