"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_components_charts_eventsRequest_tsx"],{"./app/actionCreators/events.tsx":(e,t,r)=>{r.d(t,{A5:()=>D,JE:()=>g,MD:()=>f,eV:()=>h,lI:()=>p});var s=r("../node_modules/lodash/pick.js"),a=r.n(s),i=r("./app/actionCreators/indicator.tsx"),n=r("./app/components/charts/utils.tsx"),o=r("./app/locale.tsx"),l=r("./app/utils/getPeriod.tsx"),u=r("./app/utils/performance/constants.tsx"),d=r("./app/utils/queryClient.tsx"),c=r("./app/utils/useApi.tsx"),m=r("./app/utils/useOrganization.tsx");const p=(e,t)=>{let{organization:r,project:s,environment:a,team:i,period:o,start:u,end:d,interval:c,comparisonDelta:m,includePrevious:p,query:h,yAxis:g,field:v,topEvents:f,orderby:D,partial:P,withoutZerofill:x,referrer:y,queryBatching:T,generatePathname:b,queryExtras:q,excludeOther:j,includeAllArgs:A,dataset:M,useOnDemandMetrics:E}=t;const S=b?.(r)??`/organizations/${r.slug}/events-stats/`,w=(0,n.Sw)(p,o),C={includeAllArgs:A,query:{...Object.fromEntries(Object.entries({interval:c,comparisonDelta:m,project:s,environment:a,team:i,query:h,yAxis:g,field:v,topEvents:f,orderby:D,partial:P?"1":void 0,withoutZerofill:x?"1":void 0,referrer:y||"api.organization-event-stats",excludeOther:j?"1":void 0,dataset:M,useOnDemandMetrics:E}).filter((e=>{let[,t]=e;return void 0!==t}))),...(0,l.X)({period:o,start:u,end:d},{shouldDoublePeriod:w}),...q}};return T?.batchRequest?T.batchRequest(e,S,C):e.requestPromise(S,C)};function h(e,t,r){const s={...a()(r,[...Object.values(u.s),"cursor"]),query:r.query};return e.requestPromise(`/organizations/${t}/events-facets/`,{query:s,includeAllArgs:!0})}function g(e,t,r){const s={...a()(r,Object.values(u.s)),query:r.query};return e.requestPromise(`/organizations/${t}/events-meta/`,{query:s}).then((e=>e.count))}const v=e=>{let{orgSlug:t,projectSlug:r,eventId:s}=e;return[`/projects/${t}/${r}/events/${s}/attachments/`]},f=function(e){let{orgSlug:t,projectSlug:r,eventId:s}=e,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=(0,m.Z)();return(0,d.WE)([`/projects/${t}/${r}/events/${s}/attachments/`],{staleTime:1/0,...a,enabled:(i.features?.includes("event-attachments")??!1)&&!1!==a.enabled})},D=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=(0,c.Z)({persistInFlight:!0}),r=(0,d.NL)(),s={...e,mutationFn:e=>{let{orgSlug:r,projectSlug:s,eventId:a,attachmentId:i}=e;return t.requestPromise(`/projects/${r}/${s}/events/${a}/attachments/${i}/`,{method:"DELETE"})},onMutate:async t=>{await r.cancelQueries(v(t));const s=(0,d.nE)(r,v(t));return(0,d.XN)(r,v(t),(e=>Array.isArray(e)?e.filter((e=>e?.id!==t.attachmentId)):e)),e.onMutate?.(t),{previous:s}},onError:(t,s,a)=>{(0,i.Iw)((0,o.t)("An error occurred while deleting the attachment")),a&&(0,d.XN)(r,v(s),a.previous),e.onError?.(t,s,a)}};return(0,d.Db)(s)}},"./app/components/charts/eventsRequest.tsx":(e,t,r)=>{r.d(t,{Z:()=>y});var s=r("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),a=r("../node_modules/react/index.js"),i=r("../node_modules/lodash/isEqual.js"),n=r.n(i),o=r("../node_modules/lodash/omitBy.js"),l=r.n(o),u=r("./app/actionCreators/events.tsx"),d=r("./app/actionCreators/indicator.tsx"),c=r("./app/components/charts/loadingPanel.tsx"),m=r("./app/components/charts/utils.tsx"),p=r("./app/locale.tsx"),h=r("./app/utils.tsx"),g=r("./app/utils/discover/fieldRenderers.tsx"),v=r("./app/utils/discover/fields.tsx"),f=r("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const D=["api","children","organization","loading","queryBatching","generatePathname"],P=e=>l()(e,((e,t)=>D.includes(t)));class x extends a.PureComponent{constructor(){var e;super(...arguments),e=this,(0,s.Z)(this,"state",{reloading:!!this.props.loading,errored:!1,timeseriesData:null,fetchedWithPrevious:!1}),(0,s.Z)(this,"unmounting",!1),(0,s.Z)(this,"fetchData",(async()=>{const{api:e,confirmedQuery:t,onError:r,expired:s,name:a,hideError:i,...n}=this.props;let o,l=null;if(!1!==t){if(this.setState((e=>({reloading:null!==e.timeseriesData,errored:!1,errorMessage:void 0}))),s)o=(0,p.t)("%s has an invalid date range. Please try a more recent date range.",a),(0,d.Iw)(o,{append:!0}),this.setState({errored:!0,errorMessage:o});else try{e.clear(),l=await(0,u.lI)(e,n)}catch(e){o=e&&e.responseJSON&&e.responseJSON.detail?e.responseJSON.detail:(0,p.t)("Error loading chart data"),i||(0,d.Iw)(o),r&&r(o),this.setState({errored:!0,errorMessage:o})}this.unmounting||(this.setState({reloading:!1,timeseriesData:l,fetchedWithPrevious:n.includePrevious}),n.dataLoadedCallback&&n.dataLoadedCallback(l))}})),(0,s.Z)(this,"getData",(function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const{fetchedWithPrevious:r}=e.state,{period:s,includePrevious:a}=e.props,i=r||(0,m.Sw)(a,s),n=Math.floor(t.length/2);return{current:i?t.slice(n):t,previous:i?t.slice(0,n):null}}))}componentDidMount(){this.fetchData()}componentDidUpdate(e){n()(P(e),P(this.props))||this.fetchData()}componentWillUnmount(){this.unmounting=!0}calculateTotalsPerTimestamp(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>1e3*e;return e.map(((e,r)=>{let[s,a]=e;return{name:t(s,a,r),value:a.reduce(((e,t)=>{let{count:r}=t;return e+r}),0)}}))}transformPreviousPeriodData(e,t,r){return t?{seriesName:r??"Previous",data:this.calculateTotalsPerTimestamp(t,((t,r,s)=>1e3*e[s][0])),stack:"previous"}:null}transformAggregatedTimeseries(e){return{seriesName:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",data:this.calculateTotalsPerTimestamp(e)}}transformTimeseriesData(e,t,r){let s=1;if(r){const e=t?.units?.[(0,v.LY)(r)];s=(e&&(g.a_[e]??g.en[e]))??1}return[{seriesName:r||"Current",data:e.map((e=>{let[t,r]=e;return{name:1e3*t,value:r.reduce(((e,t)=>{let{count:r}=t;return e+r}),0)*s}}))}]}transformComparisonTimeseriesData(e){return[{seriesName:"comparisonCount()",data:e.map((e=>{let[t,r]=e;return{name:1e3*t,value:r.reduce(((e,t)=>{let{comparisonCount:r}=t;return e+(r??0)}),0)}}))}]}processData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;const{data:s,isMetricsData:a,totals:i,meta:n}=e,{includeTransformedData:o,includeTimeAggregation:l,timeAggregationSeriesName:u,currentSeriesNames:d,previousSeriesNames:c,comparisonDelta:p}=this.props,{current:h,previous:g}=this.getData(s);return{data:o?this.transformTimeseriesData(h,n,r??d?.[t]):[],comparisonData:o&&p?this.transformComparisonTimeseriesData(h):[],allData:s,originalData:h,totals:i,isMetricsData:a,originalPreviousData:g,previousData:o?this.transformPreviousPeriodData(h,g,(r?(0,m.TE)(r):void 0)??c?.[t]):null,timeAggregatedData:l?this.transformAggregatedTimeseries(h,u||""):{},timeframe:e.start&&e.end?g?{start:500*(e.start+e.end),end:1e3*e.end}:{start:1e3*e.start,end:1e3*e.end}:void 0}}render(){const{children:e,showLoading:t,...r}=this.props,{topEvents:s,yAxis:a}=this.props,{timeseriesData:i,reloading:n,errored:o,errorMessage:l}=this.state,u=this.props.loading||null===i;if(t&&u)return(0,f.tZ)(c.Z,{"data-test-id":"events-request-loading"});if((0,m.Xe)(i,(0,h.ri)(s))){let t;const s={},a=Object.keys(i).map(((e,r)=>{const a=i[e],n=this.processData(a,r,(0,v.bQ)(e));return t||(t=n.timeframe),n.isMetricsData&&(s[e]={isMetricsData:n.isMetricsData}),[a.order||0,n.data[0],n.previousData,{isMetricsData:n.isMetricsData}]})).sort(((e,t)=>e[0]-t[0])),d={};Object.keys(i).forEach((e=>{const t=i[e].meta?.fields[(0,v.LY)(e)];t&&(d[e]=t)}));const c=a.map((e=>e[1])),m=a.some((e=>null===e[2]))?void 0:a.map((e=>e[2]));return e({loading:u,reloading:n,errored:o,errorMessage:l,results:c,timeframe:t,previousTimeseriesData:m,seriesAdditionalInfo:s,timeseriesResultsTypes:d,...r})}if(i){const t=a&&("string"==typeof a?a:a[0]),s=t&&i.meta?.fields[(0,v.LY)(t)],d=s?{[t]:s}:void 0,{data:c,comparisonData:m,allData:p,originalData:h,totals:g,originalPreviousData:f,previousData:D,timeAggregatedData:P,timeframe:x,isMetricsData:y}=this.processData(i);return e({loading:u,reloading:n,errored:o,errorMessage:l,seriesAdditionalInfo:{[this.props.currentSeriesNames?.[0]??"current"]:{isMetricsData:y}},timeseriesData:c,comparisonTimeseriesData:m,allTimeseriesData:p,originalTimeseriesData:h,timeseriesTotals:g,originalPreviousTimeseriesData:f,previousTimeseriesData:D?[D]:D,timeAggregatedData:P,timeframe:x,timeseriesResultsTypes:d,...r})}return e({loading:u,reloading:n,errored:o,errorMessage:l,...r})}}x.displayName="EventsRequest",(0,s.Z)(x,"defaultProps",{period:void 0,start:null,end:null,interval:"1d",comparisonDelta:void 0,limit:15,query:"",includePrevious:!0,includeTransformedData:!0});const y=x},"./app/utils/getPeriod.tsx":(e,t,r)=>{r.d(t,{X:()=>o}),r("../node_modules/core-js/modules/es.error.cause.js");var s=r("../node_modules/moment/moment.js"),a=r.n(s),i=r("./app/constants/index.tsx"),n=r("./app/utils/dates.tsx");function o(e){let{period:t,start:r,end:s}=e,{shouldDoublePeriod:o}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t||r||s||(t=i.GY),t){if(!o)return{statsPeriod:t};const[,e,r]=t.match(/([0-9]+)([mhdw])/);return{statsPeriod:`${2*parseInt(e,10)}${r}`}}if(!r||!s)throw new Error("start and end required");const l=(0,n.v5)(r),u=(0,n.v5)(s);if(o){const e=a()(s).diff(a()(r)),t=a()(r).subtract(e);return{start:(0,n.v5)(t),end:u}}return{start:l,end:u}}}}]);
//# sourceMappingURL=../sourcemaps/app_components_charts_eventsRequest_tsx.a3296851f8d4e8c690e6cd7f7ddae7d3.js.map