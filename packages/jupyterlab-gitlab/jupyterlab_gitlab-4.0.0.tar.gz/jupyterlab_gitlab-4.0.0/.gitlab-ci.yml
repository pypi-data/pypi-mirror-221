stages:
  - check
  - build
  - test
  - release

.jupyterlab_ext:
  image: condaforge/mambaforge:latest
  before_script:
    - source /opt/conda/etc/profile.d/conda.sh
    - mamba create -n jupyterlab-ext -y python=3 jupyterlab=4 nodejs=18
    - conda activate jupyterlab-ext

run-pre-commit:
  stage: check
  image: python:3.9
  before_script:
    - pip install pre-commit
  script:
    - pre-commit run --all-files

run-eslint:
  extends: .jupyterlab_ext
  stage: check
  script:
    - jlpm
    - jlpm run eslint:check

build-package:
  extends: .jupyterlab_ext
  stage: build
  script:
    - pip install build
    - python -m build .
  artifacts:
    expire_in: 1 week
    paths:
      - dist/

test-python3:
  extends: .jupyterlab_ext
  stage: test
  script:
    - python -m pip install dist/jupyterlab*.whl
    - jupyter server extension list
    - jupyter server extension list 2>&1 | grep -ie "jupyterlab_gitlab.*OK"
    - jupyter labextension list
    - jupyter labextension list 2>&1 | grep -ie "jupyterlab-gitlab.*OK"

release-pypi:
  stage: release
  image: python:3.9
  before_script:
    - pip install twine
  script:
    - twine upload dist/*
  only:
    - tags
