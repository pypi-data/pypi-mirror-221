import{r as h,m as le,D as Q,y as U,H as je,o as R,R as ce,n as we,p as xe,q as B,X as K,I as Y,s as ve,t as Ee,v as Ne,w as G,x as Ce,T as Ae,z as y,A as ke,B as J,F as De,G as ue,J as ge,K as Me,P as Fe,Q as $,u as j,U as Te,V as $e,W as k,e as L,Y as S,Z as z,$ as Le,j as t,d as w,a0 as X,a1 as W,c as F,S as ye,a2 as _e,a3 as be,a4 as de,a5 as H,a6 as Oe}from"./index-37f7281c.js";import{C as ze,I as me}from"./Input-a281f2cb.js";import{E as A}from"./context-34121116.js";import{F as Be,P as fe}from"./PlanChangePreview-d3909d31.js";import{b as Qe,u as Ue,a as N,x as Ke}from"./use-text-value-10fbadab.js";import{s as Ve,k as pe}from"./popover-0f0b8831.js";import{C as Ge}from"./CheckCircleIcon-544b1b6f.js";import"./context-8d5b0388.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-758813b5.js";import"./Graph-4e703103.js";import"./use-controllable-766f2102.js";import"./disclosure-0535eebb.js";var He=(e=>(e[e.Open=0]="Open",e[e.Closed=1]="Closed",e))(He||{}),qe=(e=>(e[e.Pointer=0]="Pointer",e[e.Other=1]="Other",e))(qe||{}),Je=(e=>(e[e.OpenMenu=0]="OpenMenu",e[e.CloseMenu=1]="CloseMenu",e[e.GoToItem=2]="GoToItem",e[e.Search=3]="Search",e[e.ClearSearch=4]="ClearSearch",e[e.RegisterItem=5]="RegisterItem",e[e.UnregisterItem=6]="UnregisterItem",e))(Je||{});function q(e,a=r=>r){let r=e.activeItemIndex!==null?e.items[e.activeItemIndex]:null,n=Me(a(e.items.slice()),d=>d.dataRef.current.domRef.current),i=r?n.indexOf(r):null;return i===-1&&(i=null),{items:n,activeItemIndex:i}}let We={1(e){return e.menuState===1?e:{...e,activeItemIndex:null,menuState:1}},0(e){return e.menuState===0?e:{...e,__demoMode:!1,menuState:0}},2:(e,a)=>{var r;let n=q(e),i=Ke(a,{resolveItems:()=>n.items,resolveActiveIndex:()=>n.activeItemIndex,resolveId:d=>d.id,resolveDisabled:d=>d.dataRef.current.disabled});return{...e,...n,searchQuery:"",activeItemIndex:i,activationTrigger:(r=a.trigger)!=null?r:1}},3:(e,a)=>{let r=e.searchQuery!==""?0:1,n=e.searchQuery+a.value.toLowerCase(),i=(e.activeItemIndex!==null?e.items.slice(e.activeItemIndex+r).concat(e.items.slice(0,e.activeItemIndex+r)):e.items).find(l=>{var s;return((s=l.dataRef.current.textValue)==null?void 0:s.startsWith(n))&&!l.dataRef.current.disabled}),d=i?e.items.indexOf(i):-1;return d===-1||d===e.activeItemIndex?{...e,searchQuery:n}:{...e,searchQuery:n,activeItemIndex:d,activationTrigger:1}},4(e){return e.searchQuery===""?e:{...e,searchQuery:"",searchActiveItemIndex:null}},5:(e,a)=>{let r=q(e,n=>[...n,{id:a.id,dataRef:a.dataRef}]);return{...e,...r}},6:(e,a)=>{let r=q(e,n=>{let i=n.findIndex(d=>d.id===a.id);return i!==-1&&n.splice(i,1),n});return{...e,...r,activationTrigger:1}}},Z=h.createContext(null);Z.displayName="MenuContext";function V(e){let a=h.useContext(Z);if(a===null){let r=new Error(`<${e} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(r,V),r}return a}function Ye(e,a){return xe(a.type,We,e,a)}let Xe=h.Fragment;function Ze(e,a){let{__demoMode:r=!1,...n}=e,i=h.useReducer(Ye,{__demoMode:r,menuState:r?0:1,buttonRef:h.createRef(),itemsRef:h.createRef(),items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[{menuState:d,itemsRef:l,buttonRef:s},c]=i,u=U(a);je([s,l],(I,P)=>{var x;c({type:1}),Ce(P,Ae.Loose)||(I.preventDefault(),(x=s.current)==null||x.focus())},d===0);let g=R(()=>{c({type:1})}),m=h.useMemo(()=>({open:d===0,close:g}),[d,g]),f={ref:u};return ce.createElement(Z.Provider,{value:i},ce.createElement(we,{value:xe(d,{0:B.Open,1:B.Closed})},K({ourProps:f,theirProps:n,slot:m,defaultTag:Xe,name:"Menu"})))}let et="button";function tt(e,a){var r;let n=Y(),{id:i=`headlessui-menu-button-${n}`,...d}=e,[l,s]=V("Menu.Button"),c=U(l.buttonRef,a),u=ve(),g=R(x=>{switch(x.key){case y.Space:case y.Enter:case y.ArrowDown:x.preventDefault(),x.stopPropagation(),s({type:0}),u.nextFrame(()=>s({type:2,focus:N.First}));break;case y.ArrowUp:x.preventDefault(),x.stopPropagation(),s({type:0}),u.nextFrame(()=>s({type:2,focus:N.Last}));break}}),m=R(x=>{switch(x.key){case y.Space:x.preventDefault();break}}),f=R(x=>{if(ke(x.currentTarget))return x.preventDefault();e.disabled||(l.menuState===0?(s({type:1}),u.nextFrame(()=>{var E;return(E=l.buttonRef.current)==null?void 0:E.focus({preventScroll:!0})})):(x.preventDefault(),s({type:0})))}),I=h.useMemo(()=>({open:l.menuState===0}),[l]),P={ref:c,id:i,type:Ve(e,l.buttonRef),"aria-haspopup":"menu","aria-controls":(r=l.itemsRef.current)==null?void 0:r.id,"aria-expanded":e.disabled?void 0:l.menuState===0,onKeyDown:g,onKeyUp:m,onClick:f};return K({ourProps:P,theirProps:d,slot:I,defaultTag:et,name:"Menu.Button"})}let nt="div",st=le.RenderStrategy|le.Static;function at(e,a){var r,n;let i=Y(),{id:d=`headlessui-menu-items-${i}`,...l}=e,[s,c]=V("Menu.Items"),u=U(s.itemsRef,a),g=Ee(s.itemsRef),m=ve(),f=Ne(),I=(()=>f!==null?(f&B.Open)===B.Open:s.menuState===0)();h.useEffect(()=>{let o=s.itemsRef.current;o&&s.menuState===0&&o!==(g==null?void 0:g.activeElement)&&o.focus({preventScroll:!0})},[s.menuState,s.itemsRef,g]),Be({container:s.itemsRef.current,enabled:s.menuState===0,accept(o){return o.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:o.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(o){o.setAttribute("role","none")}});let P=R(o=>{var C,b;switch(m.dispose(),o.key){case y.Space:if(s.searchQuery!=="")return o.preventDefault(),o.stopPropagation(),c({type:3,value:o.key});case y.Enter:if(o.preventDefault(),o.stopPropagation(),c({type:1}),s.activeItemIndex!==null){let{dataRef:v}=s.items[s.activeItemIndex];(b=(C=v.current)==null?void 0:C.domRef.current)==null||b.click()}ge(s.buttonRef.current);break;case y.ArrowDown:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.Next});case y.ArrowUp:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.Previous});case y.Home:case y.PageUp:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.First});case y.End:case y.PageDown:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.Last});case y.Escape:o.preventDefault(),o.stopPropagation(),c({type:1}),J().nextFrame(()=>{var v;return(v=s.buttonRef.current)==null?void 0:v.focus({preventScroll:!0})});break;case y.Tab:o.preventDefault(),o.stopPropagation(),c({type:1}),J().nextFrame(()=>{De(s.buttonRef.current,o.shiftKey?ue.Previous:ue.Next)});break;default:o.key.length===1&&(c({type:3,value:o.key}),m.setTimeout(()=>c({type:4}),350));break}}),x=R(o=>{switch(o.key){case y.Space:o.preventDefault();break}}),E=h.useMemo(()=>({open:s.menuState===0}),[s]),D={"aria-activedescendant":s.activeItemIndex===null||(r=s.items[s.activeItemIndex])==null?void 0:r.id,"aria-labelledby":(n=s.buttonRef.current)==null?void 0:n.id,id:d,onKeyDown:P,onKeyUp:x,role:"menu",tabIndex:0,ref:u};return K({ourProps:D,theirProps:l,slot:E,defaultTag:nt,features:st,visible:I,name:"Menu.Items"})}let rt=h.Fragment;function it(e,a){let r=Y(),{id:n=`headlessui-menu-item-${r}`,disabled:i=!1,...d}=e,[l,s]=V("Menu.Item"),c=l.activeItemIndex!==null?l.items[l.activeItemIndex].id===n:!1,u=h.useRef(null),g=U(a,u);G(()=>{if(l.__demoMode||l.menuState!==0||!c||l.activationTrigger===0)return;let v=J();return v.requestAnimationFrame(()=>{var T,M;(M=(T=u.current)==null?void 0:T.scrollIntoView)==null||M.call(T,{block:"nearest"})}),v.dispose},[l.__demoMode,u,c,l.menuState,l.activationTrigger,l.activeItemIndex]);let m=Qe(u),f=h.useRef({disabled:i,domRef:u,get textValue(){return m()}});G(()=>{f.current.disabled=i},[f,i]),G(()=>(s({type:5,id:n,dataRef:f}),()=>s({type:6,id:n})),[f,n]);let I=R(()=>{s({type:1})}),P=R(v=>{if(i)return v.preventDefault();s({type:1}),ge(l.buttonRef.current)}),x=R(()=>{if(i)return s({type:2,focus:N.Nothing});s({type:2,focus:N.Specific,id:n})}),E=Ue(),D=R(v=>E.update(v)),o=R(v=>{E.wasMoved(v)&&(i||c||s({type:2,focus:N.Specific,id:n,trigger:0}))}),C=R(v=>{E.wasMoved(v)&&(i||c&&s({type:2,focus:N.Nothing}))}),b=h.useMemo(()=>({active:c,disabled:i,close:I}),[c,i,I]);return K({ourProps:{id:n,ref:g,role:"menuitem",tabIndex:i===!0?void 0:-1,"aria-disabled":i===!0?!0:void 0,disabled:void 0,onClick:P,onFocus:x,onPointerEnter:D,onMouseEnter:D,onPointerMove:o,onMouseMove:o,onPointerLeave:C,onMouseLeave:C},theirProps:d,slot:b,defaultTag:rt,name:"Menu.Item"})}let ot=Q(Ze),lt=Q(tt),ct=Q(at),ut=Q(it),_=Object.assign(ot,{Button:lt,Items:ct,Item:ut});function Et(){const{errors:e,setIsPlanOpen:a}=Fe(),r=$(p=>p.state),n=$(p=>p.action),i=$(p=>p.setState),d=$(p=>p.setAction),l=$(p=>p.setActivePlan),s=j(p=>p.addConfirmation),c=j(p=>p.setShowConfirmation),u=j(p=>p.environment),g=j(p=>p.environments),m=j(p=>p.setInitialDates),f=j(p=>p.hasSynchronizedEnvironments),[I,P]=h.useState(!1),[x,E]=h.useState(),[D,o]=h.useState(!1),{refetch:C,data:b,isFetching:v}=Te(u.name,{planOptions:{skip_tests:!0,include_unmodified:!0}}),T=h.useCallback($e(C,1e3,!0),[C]);h.useEffect(()=>{D&&(M(),o(!1)),!k(u.isSynchronized)&&T()},[u]),h.useEffect(()=>{var p,te,ne,se,ae,re,ie,oe;b!=null&&(E(b),m(b.start,b.end),P([(p=b.changes)==null?void 0:p.added,(te=b.changes)==null?void 0:te.removed,(se=(ne=b.changes)==null?void 0:ne.modified)==null?void 0:se.direct,(re=(ae=b.changes)==null?void 0:ae.modified)==null?void 0:re.indirect,(oe=(ie=b.changes)==null?void 0:ie.modified)==null?void 0:oe.metadata].some(L)))},[b]);function M(){l(void 0),i(S.Init),d(z.Run),a(!0)}const Pe=e.size>0,Se=(k(u.isDefault)||f())&&(k(u.isDefault)||k(u.isInitial)),Re=Le([S.Applying,S.Running,S.Cancelling],r),ee=Pe||v||n!==z.None||r===S.Applying||r===S.Running||r===S.Cancelling;return t.jsxs("div",{className:w("flex items-center",u==null&&"opacity-50 pointer-events-none cursor-not-allowed"),children:[t.jsxs("div",{className:"flex items-center relative",children:[t.jsxs(X,{className:w("mx-0",k(u.isInitial&&u.isDefault)&&"rounded-none rounded-l-lg border-r"),disabled:ee,variant:W.Alternative,size:F.sm,onClick:p=>{p.stopPropagation(),u.isDefault&&k(u.isInitial)?s({headline:"Running Plan Directly On Prod Environment!",description:"Are you sure you want to run your changes directly on prod? Safer choice will be to select or add new environment first.",yesText:`Yes, Run ${u.name}`,noText:"No, Cancel",action(){M()},children:t.jsxs("div",{className:"mt-5 pt-4",children:[t.jsx("h4",{className:"mb-2",children:`${g.size>1?"Select or ":""}Add Environment`}),t.jsxs("div",{className:"flex items-center relative",children:[g.size>1&&t.jsx(he,{className:"mr-2",side:"left",environment:u,showAddEnvironment:!1,onSelect:()=>{o(!0),c(!1)},size:F.md,disabled:v||n!==z.None||r===S.Applying||r===S.Cancelling}),t.jsx(Ie,{className:"w-full",size:F.md,onAdd:()=>{o(!0),c(!1)}})]})]})}):M()},children:[Re&&t.jsx(ye,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"inline-block",children:mt(r,n)})]}),Se&&t.jsx(he,{className:"rounded-none rounded-r-lg border-l mx-0",environment:u,disabled:ee})]}),t.jsx(dt,{environment:u,plan:x,isLoading:v,hasChanges:I})]})}function dt({isLoading:e,hasChanges:a,environment:r,plan:n}){var i,d,l,s;return t.jsx("span",{className:"flex align-center h-full w-full",children:t.jsx(t.Fragment,{children:e?t.jsxs("span",{className:"flex items-center ml-2",children:[t.jsx(ye,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"inline-block text-xs text-neutral-500",children:"Checking..."})]}):t.jsxs(t.Fragment,{children:[r.isInitial&&r.isLocal&&t.jsx("span",{title:"New",className:"block ml-1 px-2 first-child:ml-0 rounded-full bg-success-10 text-success-500 text-xs text-center font-bold",children:"New"}),[a,e,r.isLocal].every(k)&&t.jsx("span",{title:"Latest",className:"block ml-1 px-2 first-child:ml-0 rounded-full bg-neutral-10 text-xs text-center",children:t.jsx("span",{children:"Latest"})}),L((i=n==null?void 0:n.changes)==null?void 0:i.added)&&t.jsx(O,{headline:"Added Models",type:A.Add,changes:n.changes.added}),L((d=n==null?void 0:n.changes)==null?void 0:d.modified.direct)&&t.jsx(O,{headline:"Direct Changes",type:A.Direct,changes:n.changes.modified.direct.map(({model_name:c})=>c)}),L((l=n==null?void 0:n.changes)==null?void 0:l.modified.indirect)&&t.jsx(O,{headline:"Indirectly Modified",type:A.Indirect,changes:n.changes.modified.indirect.map(c=>c.model_name)}),L((s=n==null?void 0:n.changes)==null?void 0:s.removed)&&t.jsx(O,{headline:"Removed Models",type:A.Remove,changes:n.changes.removed})]})})})}function he({onSelect:e,environment:a,disabled:r,side:n=H.Right,className:i,showAddEnvironment:d=!0,size:l=F.sm}){const s=j(m=>m.environments),c=j(m=>m.setEnvironment),u=j(m=>m.removeLocalEnvironment),g=_e(_.Button);return t.jsx(_,{children:({close:m})=>t.jsxs(t.Fragment,{children:[t.jsxs(g,{variant:W.Alternative,size:l,disabled:r,className:w(i),children:[t.jsx("span",{className:w("block overflow-hidden truncate",(a.isLocal||r)&&"text-neutral-500",a.isSynchronized&&"text-primary-500"),children:a.name}),t.jsx("span",{className:"pointer-events-none inset-y-0 right-0 flex items-center pl-2",children:t.jsx(ze,{className:"h-4 w-4","aria-hidden":"true"})})]}),t.jsx(be,{as:h.Fragment,leave:"transition ease-in duration-100",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:t.jsxs("div",{className:w("absolute top-9 overflow-hidden shadow-xl bg-theme border-2 border-primary-20 rounded-md flex flex-col z-10",n===H.Left&&"left-0",n===H.Right&&"right-0"),children:[t.jsxs(_.Items,{className:"overflow-auto max-h-80 py-2 hover:scrollbar scrollbar--vertical",children:[Array.from(s).map(f=>t.jsx(_.Item,{children:({active:I})=>t.jsxs("div",{onClick:P=>{P.stopPropagation(),c(f),e==null||e()},className:w("flex justify-between items-center px-4 py-1 cursor-pointer overflow-auto",I&&"bg-primary-10",f===a&&"pointer-events-none cursor-default bg-secondary-10"),children:[t.jsxs("div",{className:"flex items-start",children:[t.jsx(Ge,{className:w("w-4 h-4 text-primary-500 mt-1",I&&"opacity-10",f!==a&&"opacity-0")}),t.jsxs("span",{className:"block",children:[t.jsxs("span",{className:"flex items-center",children:[t.jsx("span",{className:w("block truncate ml-2",f.isSynchronized&&"text-primary-500"),children:f.name}),t.jsxs("small",{className:"block ml-2",children:["(",f.type,")"]})]}),f.isDefault&&t.jsx("span",{className:"flex ml-2",children:t.jsx("small",{className:"text-xs text-neutral-500",children:"Default Environment"})})]})]}),f.isLocal&&f!==a&&t.jsx(X,{className:"my-0 mx-0",size:F.xs,variant:W.Neutral,onClick:P=>{P.stopPropagation(),u(f)},children:"-"})]})},f.name)),d&&t.jsxs(t.Fragment,{children:[t.jsx(de,{}),t.jsx(Ie,{onAdd:m,className:"mt-2 px-2"})]})]}),t.jsx(de,{})]})})]})})}function Ie({onAdd:e,className:a,label:r="Add",size:n=F.sm}){const i=j(m=>m.getNextEnvironment),d=j(m=>m.isExistingEnvironment),l=j(m=>m.addLocalEnvironment),[s,c]=h.useState(""),[u,g]=h.useState(i().name);return t.jsxs("div",{className:w("flex w-full items-center",a),children:[t.jsx(me,{className:"my-0 mx-0 mr-4 min-w-[10rem] w-full",size:n,children:({className:m})=>t.jsx(me.Textfield,{className:w(m,"w-full"),placeholder:"Environment",value:s,onInput:f=>{f.stopPropagation(),c(f.target.value)}})}),t.jsx(X,{className:"my-0 mx-0 font-bold",size:n,disabled:Oe(s)||d(s),onClick:m=>{m.stopPropagation(),l(s,u),c(""),g(i().name),e==null||e()},children:r})]})}function O({headline:e,type:a,changes:r}){const[n,i]=h.useState(!1);return t.jsx(pe,{onMouseEnter:()=>{i(!0)},onMouseLeave:()=>{i(!1)},className:"relative flex",children:()=>t.jsxs(t.Fragment,{children:[t.jsx("span",{className:w("inline-block ml-1 px-2 rounded-full text-xs font-bold text-neutral-100 cursor-default border border-inherit",a===A.Add&&"bg-success-500 border-success-500",a===A.Remove&&"bg-danger-500 border-danger-500",a===A.Direct&&"bg-secondary-500 border-secondary-500",a===A.Indirect&&"bg-warning-500 border-warning-500",a==="metadata"&&"bg-neutral-500 border-neutral-500"),children:r.length}),t.jsx(be,{show:n,as:h.Fragment,enter:"transition ease-out duration-200",enterFrom:"opacity-0 translate-y-1",enterTo:"opacity-100 translate-y-0",leave:"transition ease-in duration-150",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-1",children:t.jsx(pe.Panel,{className:"absolute right-1 z-10 mt-8 transform flex p-2 bg-theme-lighter shadow-xl focus:ring-2 ring-opacity-5 rounded-lg ",children:t.jsx(fe,{headline:e,type:a,className:"w-full h-full max-h-[40vh] overflow-hidden overflow-y-auto ",children:t.jsx(fe.Default,{type:a,changes:r})})})})]})})}function mt(e,a){return e===S.Running?"Running Plan...":e===S.Applying?"Applying Plan...":e===S.Cancelling?"Cancelling Plan...":a===z.None?"Run Plan":"Setting Plan..."}export{Et as default};
